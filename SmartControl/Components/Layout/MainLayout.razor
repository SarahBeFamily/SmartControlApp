@implements IDisposable
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<DxLayoutBreakpoint DeviceSize="DeviceSize.XSmall" @bind-IsActive="@isXSmallScreen" />

<div class="page">

    <header id="main" class="flex flex-between">

        @if (isXSmallScreen)
        {
            <div id="ham" onclick="(document.getElementById('sidebar').classList.toggle('auto-expanded'));(this.classList.toggle('open'))">
                <i class="bi bi-list"></i>
                <i class="bi bi-x"></i>
            </div>
        } else
		{
            <div id="brand-image">
                <div class="menu-button" onclick="(document.getElementById('sidebar').classList.toggle('auto-expanded'))">
                    <img src="images/Logo_SmartControl.svg" alt="SmartControl" class="brand-image" width="39" height="48" />
                </div>
            </div>
		}

        <div class="w-100 nav-buttons-container">

            <!-- PROVVISORIO: per me che non ho l'accesso -->
            
            <div id="user-area">
                <div class="menu-button d-flex align-items-center" onclick="(document.getElementById('user-dropdown-panel').classList.toggle('open'))" onmouseover="(document.getElementById('user-dropdown-panel').classList.add('open'))">
                    <div class="user-image"><i class="bi bi-person-fill"></i></div>
                    <div class="user-info d-flex flex-column mx-3">
                        <span class="email">mail@mail.it</span>
                        <span class="company">Azienda</span>
                    </div>
                </div>

                <div id="user-dropdown-panel" class="dropdown-area" onmouseleave="(this.classList.remove('open'))">

                    <form action="Account/Logout" method="get" class="display-desktop">
                        <AntiforgeryToken />
                        <DxButton RenderStyle="@ButtonRenderStyle.Link" CssClass="menu-button"  SubmitFormOnClick="true" Text="Esci" RenderStyleMode="@ButtonRenderStyleMode.Text"></DxButton>
                    </form>
                </div>
            </div>

            <!-- DEFINITIVO: utente già loggato -->
            
            @* <AuthorizeView>
                <Authorized>
                    <button class="rounded-button" @onclick="OpenNotifications"><i class="icon-notification"></i></button>

                    <div id="user-area">
                        <div class="menu-button d-flex align-items-center">
                            <div class="user-image" onclick="(document.getElementById('user-dropdown-panel').classList.toggle('open'))"><i class="bi bi-person-fill"></i></div>
                            <div class="user-info d-flex flex-column mx-3">
                                <span class="email">i.modenin@axxelera.it</span>
                                <span class="company">Azienda</span>
                            </div>
				        </div>

                        <div id="user-dropdown-panel" class="dropdown-area">
                            <DxButton RenderStyle="@ButtonRenderStyle.Link" CssClass="menu-button" NavigateUrl="Account/Manage" Text="Profilo" RenderStyleMode="@ButtonRenderStyleMode.Text"></DxButton>
                            <form action="Account/Logout" method="post" class="display-desktop">
                                <AntiforgeryToken />
                                <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                                <DxButton RenderStyle="@ButtonRenderStyle.Link" SubmitFormOnClick="true" Text="Esci" RenderStyleMode="@ButtonRenderStyleMode.Text"></DxButton>
                            </form>
                        </div>
                    </div>
                </Authorized>
            </AuthorizeView> *@

        </div>

       
    </header>

    @{
        var sidebarClass = isXSmallScreen ? "auto-expanded" : "";
        var flexWrap = isXSmallScreen ? " flex-wrap" : "";
    }

    <div id="main-container" class="flex @flexWrap">
        <div id="sidebar" class="@sidebarClass">

            @* To Do: creare componente per questo blocco *@
            <div class="company flex">
                <img src="images/company-sidebar.png" alt="" />
                <div class="info">
                    <span class="name">Credipass srl</span>
					<span class="role">Hgroup</span>
                </div>
            </div>

            <SC_Divider></SC_Divider>

            <SC_Menu Menu="main"></SC_Menu>

            <SC_Divider></SC_Divider>

            <SC_Menu Menu="settings"></SC_Menu>
        </div>

        <div class="main-content">
            @Body
        </div>
    </div>

    <footer>

    </footer>
</div>

@code {
    public bool isXSmallScreen { get; set; }
    private string? currentUrl;


    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

}
